head	1.1;
access;
symbols;
locks; strict;
comment	@# @;


1.1
date	2011.03.29.00.59.26;	author zhang-tengyu;	state Exp;
branches;
next	;
deltatype	text;
kopt	b;
permissions	666;
commitid	5284d912ee43493;
filename	req_acc_margin_view.sql;


desc
@@


1.1
log
@*** empty log message ***
@
text
@CREATE OR REPLACE VIEW REQUISITION_ACCOUNT_MARGIN AS
(
SELECT
    CALC_RESULT_MARGIN_ID,
    INSTITUTION_CODE,
    BRANCH_CODE,
    ACCOUNT_CODE,
    FAMILY_NAME,
    SONAR_TRADER_CODE,
    MARK_TO_MARKET_DIV,
    TRUNC( REC_MARGIN_DEP_0 )     AS RECEIPT_MARGIN_DEPOSIT_0,
    TRUNC( REC_MARGIN_DEP_1 )     AS RECEIPT_MARGIN_DEPOSIT_1,
    TRUNC( REC_MARGIN_DEP_2 )     AS RECEIPT_MARGIN_DEPOSIT_2,
    TRUNC( REC_MARGIN_DEP_3 )     AS RECEIPT_MARGIN_DEPOSIT_3,
    TRUNC( REC_MARGIN_DEP_4 )     AS RECEIPT_MARGIN_DEPOSIT_4,
    TRUNC( REC_MARGIN_DEP_5 )     AS RECEIPT_MARGIN_DEPOSIT_5,
    TRUNC( MARGIN_MAIN_AMT_0 )    AS MARGIN_MAINTENANCE_AMOUNT_0,
    TRUNC( MARGIN_MAIN_AMT_1 )    AS MARGIN_MAINTENANCE_AMOUNT_1,
    TRUNC( MARGIN_MAIN_AMT_2 )    AS MARGIN_MAINTENANCE_AMOUNT_2,
    TRUNC( MARGIN_MAIN_AMT_3 )    AS MARGIN_MAINTENANCE_AMOUNT_3,
    TRUNC( MARGIN_MAIN_AMT_4 )    AS MARGIN_MAINTENANCE_AMOUNT_4,
    TRUNC( MARGIN_MAIN_AMT_5 )    AS MARGIN_MAINTENANCE_AMOUNT_5,
    TRUNC( MARGIN_DEP_RATE_0, 2 ) AS MARGIN_DEPOSIT_RATE_0,
    TRUNC( MARGIN_DEP_RATE_1, 2 ) AS MARGIN_DEPOSIT_RATE_1,
    TRUNC( MARGIN_DEP_RATE_2, 2 ) AS MARGIN_DEPOSIT_RATE_2,
    TRUNC( MARGIN_DEP_RATE_3, 2 ) AS MARGIN_DEPOSIT_RATE_3,
    TRUNC( MARGIN_DEP_RATE_4, 2 ) AS MARGIN_DEPOSIT_RATE_4,
    TRUNC( MARGIN_DEP_RATE_5, 2 ) AS MARGIN_DEPOSIT_RATE_5,
    DEBIT_AMOUNT_0,
    DEBIT_AMOUNT_1,
    DEBIT_AMOUNT_2,
    DEBIT_AMOUNT_3,
    DEBIT_AMOUNT_4,
    DEBIT_AMOUNT_5,
    SPECIAL_DEBIT_AMOUNT_0,
    SPECIAL_DEBIT_AMOUNT_1,
    SPECIAL_DEBIT_AMOUNT_2,
    SPECIAL_DEBIT_AMOUNT_3,
    SPECIAL_DEBIT_AMOUNT_4,
    SPECIAL_DEBIT_AMOUNT_5,
    TRUNC( MARGIN_CLAIMED_AMT_0 ) AS MARGIN_CLAIMED_AMOUNT_0,
    TRUNC( MARGIN_CLAIMED_AMT_1 ) AS MARGIN_CLAIMED_AMOUNT_1,
    TRUNC( MARGIN_CLAIMED_AMT_2 ) AS MARGIN_CLAIMED_AMOUNT_2,
    TRUNC( MARGIN_CLAIMED_AMT_3 ) AS MARGIN_CLAIMED_AMOUNT_3,
    TRUNC( MARGIN_CLAIMED_AMT_4 ) AS MARGIN_CLAIMED_AMOUNT_4,
    TRUNC( MARGIN_CLAIMED_AMT_5 ) AS MARGIN_CLAIMED_AMOUNT_5
 FROM
(
    SELECT
        A.CALC_RESULT_MARGIN_ID   AS CALC_RESULT_MARGIN_ID,
        B.INSTITUTION_CODE        AS INSTITUTION_CODE,
        B.BRANCH_CODE             AS BRANCH_CODE,
        B.ACCOUNT_CODE            AS ACCOUNT_CODE,
        B.FAMILY_NAME             AS FAMILY_NAME,
        B.SONAR_TRADER_CODE       AS SONAR_TRADER_CODE,
        A.MARK_TO_MARKET_DIV      AS MARK_TO_MARKET_DIV,
        A.REC_MARGIN_DEP_0        AS REC_MARGIN_DEP_0,
        A.REC_MARGIN_DEP_1        AS REC_MARGIN_DEP_1,
        A.REC_MARGIN_DEP_2        AS REC_MARGIN_DEP_2,
        A.REC_MARGIN_DEP_3        AS REC_MARGIN_DEP_3,
        A.REC_MARGIN_DEP_4        AS REC_MARGIN_DEP_4,
        A.REC_MARGIN_DEP_5        AS REC_MARGIN_DEP_5,
        A.CONT_AMT_0 * C.MARGIN_MAINTENANCE_RATE / 100                          AS MARGIN_MAIN_AMT_0,
        A.CONT_AMT_1 * C.MARGIN_MAINTENANCE_RATE / 100                          AS MARGIN_MAIN_AMT_1,
        A.CONT_AMT_2 * C.MARGIN_MAINTENANCE_RATE / 100                          AS MARGIN_MAIN_AMT_2,
        A.CONT_AMT_3 * C.MARGIN_MAINTENANCE_RATE / 100                          AS MARGIN_MAIN_AMT_3,
        A.CONT_AMT_4 * C.MARGIN_MAINTENANCE_RATE / 100                          AS MARGIN_MAIN_AMT_4,
        A.CONT_AMT_5 * C.MARGIN_MAINTENANCE_RATE / 100                          AS MARGIN_MAIN_AMT_5,
        DECODE( A.CONT_AMT_0, 0, 0, A.REC_MARGIN_DEP_0 / A.CONT_AMT_0) * 100    AS MARGIN_DEP_RATE_0,
        DECODE( A.CONT_AMT_1, 0, 0, A.REC_MARGIN_DEP_1 / A.CONT_AMT_1) * 100    AS MARGIN_DEP_RATE_1,
        DECODE( A.CONT_AMT_2, 0, 0, A.REC_MARGIN_DEP_2 / A.CONT_AMT_2) * 100    AS MARGIN_DEP_RATE_2,
        DECODE( A.CONT_AMT_3, 0, 0, A.REC_MARGIN_DEP_3 / A.CONT_AMT_3) * 100    AS MARGIN_DEP_RATE_3,
        DECODE( A.CONT_AMT_4, 0, 0, A.REC_MARGIN_DEP_4 / A.CONT_AMT_4) * 100    AS MARGIN_DEP_RATE_4,
        DECODE( A.CONT_AMT_5, 0, 0, A.REC_MARGIN_DEP_5 / A.CONT_AMT_5) * 100    AS MARGIN_DEP_RATE_5,
        ABS( LEAST(A.REAL_BAL_0, 0))                                            AS DEBIT_AMOUNT_0,
        ABS( LEAST(A.REAL_BAL_1, 0))                                            AS DEBIT_AMOUNT_1,
        ABS( LEAST(A.REAL_BAL_2, 0))                                            AS DEBIT_AMOUNT_2,
        ABS( LEAST(A.REAL_BAL_3, 0))                                            AS DEBIT_AMOUNT_3,
        ABS( LEAST(A.REAL_BAL_4, 0))                                            AS DEBIT_AMOUNT_4,
        ABS( LEAST(A.REAL_BAL_5, 0))                                            AS DEBIT_AMOUNT_5,
        ABS( LEAST(A.REAL_BAL_0 - A.DAY_TRADE_RESTRAINT_0, 0))                  AS SPECIAL_DEBIT_AMOUNT_0,
        ABS( LEAST(A.REAL_BAL_1 - A.DAY_TRADE_RESTRAINT_1, 0))                  AS SPECIAL_DEBIT_AMOUNT_1,
        ABS( LEAST(A.REAL_BAL_2 - A.DAY_TRADE_RESTRAINT_2, 0))                  AS SPECIAL_DEBIT_AMOUNT_2,
        ABS( LEAST(A.REAL_BAL_3 - A.DAY_TRADE_RESTRAINT_3, 0))                  AS SPECIAL_DEBIT_AMOUNT_3,
        ABS( LEAST(A.REAL_BAL_4 - A.DAY_TRADE_RESTRAINT_4, 0))                  AS SPECIAL_DEBIT_AMOUNT_4,
        ABS( LEAST(A.REAL_BAL_5, 0))                                            AS SPECIAL_DEBIT_AMOUNT_5,
        DECODE( A.CONT_AMT_0, 0, 0, ABS( LEAST(
            A.PAID_MARGIN_DEP_0 - C.MIN_MARGIN_DEPOSIT,
            A.REC_MARGIN_DEP_0 - GREATEST( A.CONT_AMT_0 * C.MARGIN_MAINTENANCE_RATE / 100, 300000)
            , 0
        ))) AS MARGIN_CLAIMED_AMT_0,
        DECODE( A.CONT_AMT_1, 0, 0, ABS( LEAST(
            A.PAID_MARGIN_DEP_1 - C.MIN_MARGIN_DEPOSIT,
            A.REC_MARGIN_DEP_1 - GREATEST( A.CONT_AMT_1 * C.MARGIN_MAINTENANCE_RATE / 100, 300000)
            , 0
        ))) AS MARGIN_CLAIMED_AMT_1,
        DECODE( A.CONT_AMT_2, 0, 0, ABS( LEAST(
            A.PAID_MARGIN_DEP_2 - C.MIN_MARGIN_DEPOSIT,
            A.REC_MARGIN_DEP_2 - GREATEST( A.CONT_AMT_2 * C.MARGIN_MAINTENANCE_RATE / 100, 300000)
            , 0
        ))) AS MARGIN_CLAIMED_AMT_2,
        DECODE( A.CONT_AMT_3, 0, 0, ABS( LEAST(
            A.PAID_MARGIN_DEP_3 - C.MIN_MARGIN_DEPOSIT,
            A.REC_MARGIN_DEP_3 - GREATEST( A.CONT_AMT_3 * C.MARGIN_MAINTENANCE_RATE / 100, 300000)
            , 0
        ))) AS MARGIN_CLAIMED_AMT_3,
        DECODE( A.CONT_AMT_4, 0, 0, ABS( LEAST(
            A.PAID_MARGIN_DEP_4 - C.MIN_MARGIN_DEPOSIT,
            A.REC_MARGIN_DEP_4 - GREATEST( A.CONT_AMT_4 * C.MARGIN_MAINTENANCE_RATE / 100, 300000)
            , 0
        ))) AS MARGIN_CLAIMED_AMT_4,
        DECODE( A.CONT_AMT_5, 0, 0, ABS( LEAST(
            A.PAID_MARGIN_DEP_5 - C.MIN_MARGIN_DEPOSIT,
            A.REC_MARGIN_DEP_5 - GREATEST( A.CONT_AMT_5 * C.MARGIN_MAINTENANCE_RATE / 100, 300000)
            , 0
        ))) AS MARGIN_CLAIMED_AMT_5
    FROM
    (
        SELECT
            CALC_RESULT_MARGIN_ID,
            ACCOUNT_ID,
            MARK_TO_MARKET_DIV,
            ACCOUNT_BALANCE_0 - TODAY_EXECUTED_AMOUNT_0 - TODAY_UNEXECUTED_AMOUNT_0 - OTHER_RESTRAINT_0 AS REAL_BAL_0,
            ACCOUNT_BALANCE_1 - TODAY_EXECUTED_AMOUNT_1 - TODAY_UNEXECUTED_AMOUNT_1 - OTHER_RESTRAINT_1 AS REAL_BAL_1,
            ACCOUNT_BALANCE_2 - TODAY_EXECUTED_AMOUNT_2 - TODAY_UNEXECUTED_AMOUNT_2 - OTHER_RESTRAINT_2 AS REAL_BAL_2,
            ACCOUNT_BALANCE_3 - TODAY_EXECUTED_AMOUNT_3 - TODAY_UNEXECUTED_AMOUNT_3 - OTHER_RESTRAINT_3 AS REAL_BAL_3,
            ACCOUNT_BALANCE_4 - TODAY_EXECUTED_AMOUNT_4 - TODAY_UNEXECUTED_AMOUNT_4 - OTHER_RESTRAINT_4 AS REAL_BAL_4,
            ACCOUNT_BALANCE_5 - TODAY_EXECUTED_AMOUNT_5 - TODAY_UNEXECUTED_AMOUNT_5 - OTHER_RESTRAINT_5 AS REAL_BAL_5,
            DAY_TRADE_RESTRAINT_0,
            DAY_TRADE_RESTRAINT_1,
            DAY_TRADE_RESTRAINT_2,
            DAY_TRADE_RESTRAINT_3,
            DAY_TRADE_RESTRAINT_4,
            CONTRACT_AMOUNT_0 + DAY_REPAY_CONTRACT_AMOUNT_0                                             AS CONT_AMT_0,
            CONTRACT_AMOUNT_1 + DAY_REPAY_CONTRACT_AMOUNT_1                                             AS CONT_AMT_1,
            CONTRACT_AMOUNT_2 + DAY_REPAY_CONTRACT_AMOUNT_2                                             AS CONT_AMT_2,
            CONTRACT_AMOUNT_3 + DAY_REPAY_CONTRACT_AMOUNT_3                                             AS CONT_AMT_3,
            CONTRACT_AMOUNT_4 + DAY_REPAY_CONTRACT_AMOUNT_4                                             AS CONT_AMT_4,
            CONTRACT_AMOUNT_5 + DAY_REPAY_CONTRACT_AMOUNT_5                                             AS CONT_AMT_5,
            ACCOUNT_BALANCE_0 - TODAY_EXECUTED_AMOUNT_0 - TODAY_UNEXECUTED_AMOUNT_0 - OTHER_RESTRAINT_0
                + (SUBSTITUTE_SECURITY_ASSET_0 * (100 - 0) / 100)                                       AS PAID_MARGIN_DEP_0,
            ACCOUNT_BALANCE_1 - TODAY_EXECUTED_AMOUNT_1 - TODAY_UNEXECUTED_AMOUNT_1 - OTHER_RESTRAINT_1
                + (SUBSTITUTE_SECURITY_ASSET_1 * (100 - 0) / 100)                                       AS PAID_MARGIN_DEP_1,
            ACCOUNT_BALANCE_2 - TODAY_EXECUTED_AMOUNT_2 - TODAY_UNEXECUTED_AMOUNT_2 - OTHER_RESTRAINT_2
                + (SUBSTITUTE_SECURITY_ASSET_2 * (100 - 0) / 100)                                       AS PAID_MARGIN_DEP_2,
            ACCOUNT_BALANCE_3 - TODAY_EXECUTED_AMOUNT_3 - TODAY_UNEXECUTED_AMOUNT_3 - OTHER_RESTRAINT_3
                + (SUBSTITUTE_SECURITY_ASSET_3 * (100 - 0) / 100)                                       AS PAID_MARGIN_DEP_3,
            ACCOUNT_BALANCE_4 - TODAY_EXECUTED_AMOUNT_4 - TODAY_UNEXECUTED_AMOUNT_4 - OTHER_RESTRAINT_4
                + (SUBSTITUTE_SECURITY_ASSET_4 * (100 - 0) / 100)                                       AS PAID_MARGIN_DEP_4,
            ACCOUNT_BALANCE_5 - TODAY_EXECUTED_AMOUNT_5 - TODAY_UNEXECUTED_AMOUNT_5 - OTHER_RESTRAINT_5
                + (SUBSTITUTE_SECURITY_ASSET_5 * (100 - 0) / 100)                                       AS PAID_MARGIN_DEP_5,
            ACCOUNT_BALANCE_0 - TODAY_EXECUTED_AMOUNT_0 - TODAY_UNEXECUTED_AMOUNT_0 - OTHER_RESTRAINT_0
                + (SUBSTITUTE_SECURITY_ASSET_0 * (100 - 0) / 100)
                + LEAST(CONTRACT_ASSET_PROFIT_LOSS, 0) - CONTRACT_TOTAL_COST - UNDELI_CONTRACT_LOSS_0   AS REC_MARGIN_DEP_0,
            ACCOUNT_BALANCE_1 - TODAY_EXECUTED_AMOUNT_1 - TODAY_UNEXECUTED_AMOUNT_1 - OTHER_RESTRAINT_1
                + (SUBSTITUTE_SECURITY_ASSET_1 * (100 - 0) / 100)
                + LEAST( NVL(CONTRACT_ASSET_PROFIT_LOSS_1, 0) , 0) - CONTRACT_TOTAL_COST - UNDELI_CONTRACT_LOSS_1   AS REC_MARGIN_DEP_1,
            ACCOUNT_BALANCE_2 - TODAY_EXECUTED_AMOUNT_2 - TODAY_UNEXECUTED_AMOUNT_2 - OTHER_RESTRAINT_2
                + (SUBSTITUTE_SECURITY_ASSET_2 * (100 - 0) / 100)
                + LEAST( NVL(CONTRACT_ASSET_PROFIT_LOSS_2, 0), 0) - CONTRACT_TOTAL_COST - UNDELI_CONTRACT_LOSS_2   AS REC_MARGIN_DEP_2,
            ACCOUNT_BALANCE_3 - TODAY_EXECUTED_AMOUNT_3 - TODAY_UNEXECUTED_AMOUNT_3 - OTHER_RESTRAINT_3
                + (SUBSTITUTE_SECURITY_ASSET_3 * (100 - 0) / 100)
                + LEAST( NVL(CONTRACT_ASSET_PROFIT_LOSS_3, 0), 0) - CONTRACT_TOTAL_COST - UNDELI_CONTRACT_LOSS_3   AS REC_MARGIN_DEP_3,
            ACCOUNT_BALANCE_4 - TODAY_EXECUTED_AMOUNT_4 - TODAY_UNEXECUTED_AMOUNT_4 - OTHER_RESTRAINT_4
                + (SUBSTITUTE_SECURITY_ASSET_4 * (100 - 0) / 100)
                + LEAST( NVL(CONTRACT_ASSET_PROFIT_LOSS_4, 0), 0) - CONTRACT_TOTAL_COST                            AS REC_MARGIN_DEP_4,
            ACCOUNT_BALANCE_5 - TODAY_EXECUTED_AMOUNT_5 - TODAY_UNEXECUTED_AMOUNT_5 - OTHER_RESTRAINT_5
                + (SUBSTITUTE_SECURITY_ASSET_5 * (100 - 0) / 100)
                + LEAST( NVL(CONTRACT_ASSET_PROFIT_LOSS_5, 0), 0) - CONTRACT_TOTAL_COST                            AS REC_MARGIN_DEP_5
        FROM
            TP_CALC_RESULT_MARGIN
        WHERE
            (
                ACCOUNT_ID,
                CREATED_TIMESTAMP
            )
            IN
            (
                SELECT
                    A.ACCOUNT_ID,
                    MAX(A.CREATED_TIMESTAMP)
                FROM
                    TP_CALC_RESULT_MARGIN A, MAIN_ACCOUNT B
                WHERE
                    A.ACCOUNT_ID            = B.ACCOUNT_ID
                GROUP BY
                    A.ACCOUNT_ID, A.MARK_TO_MARKET_DIV
            )
        ) A,
        MAIN_ACCOUNT B,
        BRANCH C
    WHERE
        A.ACCOUNT_ID    = B.ACCOUNT_ID  AND
        B.BRANCH_ID     = C.BRANCH_ID
)
WHERE
    DEBIT_AMOUNT_0         > 0 OR
    DEBIT_AMOUNT_1         > 0 OR
    DEBIT_AMOUNT_2         > 0 OR
    DEBIT_AMOUNT_3         > 0 OR
    DEBIT_AMOUNT_4         > 0 OR
    DEBIT_AMOUNT_5         > 0 OR
    SPECIAL_DEBIT_AMOUNT_0 > 0 OR
    SPECIAL_DEBIT_AMOUNT_1 > 0 OR
    SPECIAL_DEBIT_AMOUNT_2 > 0 OR
    SPECIAL_DEBIT_AMOUNT_3 > 0 OR
    SPECIAL_DEBIT_AMOUNT_4 > 0 OR
    SPECIAL_DEBIT_AMOUNT_5 > 0 OR
    MARGIN_CLAIMED_AMT_0   > 0 OR
    MARGIN_CLAIMED_AMT_1   > 0 OR
    MARGIN_CLAIMED_AMT_2   > 0 OR
    MARGIN_CLAIMED_AMT_3   > 0 OR
    MARGIN_CLAIMED_AMT_4   > 0 OR
    MARGIN_CLAIMED_AMT_5   > 0
);
@
